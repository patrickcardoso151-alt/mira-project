<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M.I.R.A. v10.0 - Neural Core</title>
    <style>
        :root { --mira-green: #00ff41; --mira-bg: #000b00; }
        
        /* Ajuste para garantir que nada suma no navegador do celular */
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background: var(--mira-bg); 
            color: var(--mira-green); 
            font-family: 'Courier New', monospace; 
            overflow: hidden;
        }

        #terminal { 
            display: flex; 
            flex-direction: column; 
            height: 100dvh; /* Usa a altura dinâmica do navegador */
            padding: 15px; 
            box-sizing: border-box; 
            border: 2px solid var(--mira-green); 
        }

        #hud { display: flex; justify-content: space-between; font-size: 0.65rem; margin-bottom: 5px; opacity: 0.8; }
        
        #vision-container { display: none; width: 100%; height: 120px; border: 1px solid var(--mira-green); margin: 10px 0; overflow: hidden; position: relative; }
        #video { width: 100%; height: 100%; object-fit: cover; filter: sepia(1) hue-rotate(90deg) brightness(0.8); }
        
        #avatar-container { display: flex; justify-content: center; align-items: center; min-height: 80px; }
        #mira-orb { width: 60px; height: 60px; border-radius: 50%; background: radial-gradient(circle, var(--mira-green) 0%, transparent 70%); box-shadow: 0 0 20px var(--mira-green); transition: all 0.5s; }
        
        #log { flex-grow: 1; overflow-y: auto; font-size: 0.85rem; padding: 10px 0; border-top: 1px solid #003300; }
        
        /* Área de input reforçada para mobile */
        .input-area { 
            display: flex; 
            align-items: center;
            border-top: 2px solid var(--mira-green); 
            padding: 15px 0; 
            background: var(--mira-bg);
            margin-bottom: 5px;
        }
        
        input { 
            background: transparent; 
            border: none; 
            color: var(--mira-green); 
            outline: none; 
            flex-grow: 1; 
            font-size: 1.1rem; /* Maior para facilitar o toque */
        }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; cursor: pointer; text-align: center; padding: 20px; box-sizing: border-box;}
        .forma-circulo { clip-path: circle(50%); }
        .forma-hex { clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); }
    </style>
</head>
<body>

<div id="overlay" onclick="iniciarMIRA()">[ CLIQUE PARA CONECTAR À MATRIZ M.I.R.A. v10.0 ]</div>

<div id="terminal">
    <div id="hud">
        <span>OP: PATRICK</span>
        <span id="sync-status">NEURAL: ONLINE</span>
    </div>

    <div id="vision-container">
        <video id="video" autoplay playsinline></video>
    </div>

    <div id="avatar-container">
        <div id="mira-orb" class="forma-circulo"></div>
    </div>

    <div id="log"></div>

    <div class="input-area">
        <span style="color:var(--mira-green); font-weight:bold; margin-right:8px;">CMD></span>
        <input type="text" id="inputComando" placeholder="Escreva aqui..." autocomplete="off">
    </div>
</div>

<script>
    let userDados = JSON.parse(localStorage.getItem('mira_data')) || { nome: "Patrick", notas: [] };
    
    function addLog(o, t) {
        const log = document.getElementById('log');
        log.innerHTML += `<div><b>[${o}]</b> ${t}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function falar(t) {
        window.speechSynthesis.cancel();
        const m = new SpeechSynthesisUtterance(t);
        m.lang = 'pt-BR';
        window.speechSynthesis.speak(m);
    }

    function mudarEstado(est) {
        const orb = document.getElementById('mira-orb');
        if(est === 'analise') {
            orb.style.background = "white";
            orb.className = "forma-hex";
        } else {
            orb.style.background = "var(--mira-green)";
            orb.className = "forma-circulo";
        }
    }

    async function ativarVisao() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video').srcObject = s;
            document.getElementById('vision-container').style.display = "block";
            falar("Sensores óticos online.");
        } catch (e) { addLog("ERRO", "Câmera inacessível."); }
    }

    async function pensarComGemini(pergunta) {
        let apiKey = localStorage.getItem('gemini_key');
        
        if (!apiKey) {
            apiKey = prompt("M.I.R.A. - Insira sua API Key (aquela que começa com AIza):");
            if (apiKey) {
                apiKey = apiKey.trim();
                localStorage.setItem('gemini_key', apiKey);
                addLog("SISTEMA", "Chave neural sincronizada.");
            } else return;
        }

        mudarEstado("analise");
        addLog("M.I.R.A.", "Consultando matriz...");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: pergunta }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const respostaIA = data.candidates[0].content.parts[0].text;
            mudarEstado("estavel");
            addLog("M.I.R.A.", respostaIA);
            falar(respostaIA);
        } catch (erro) {
            addLog("ERRO", "Falha: " + erro.message);
            mudarEstado("estavel");
            if(erro.message.includes("API key")) localStorage.removeItem('gemini_key');
        }
    }

    async function processar(val) {
        if(!val.trim()) return;
        const msg = val.toLowerCase();
        addLog("PATRICK", val);
        document.getElementById('inputComando').value = "";

        if (msg.includes("câmera") || msg.includes("veja")) { ativarVisao(); return; }
        
        if (msg.includes("tempo em")) {
            const cidade = msg.split(" em ")[1];
            try {
                const res = await fetch(`https://api.hgbrasil.com/weather?format=json-cors&key=707b99d0&city_name=${cidade}`);
                const d = await res.json();
                const r = `Clima em ${d.results.city}: ${d.results.description}, ${d.results.temp}°C.`;
                addLog("M.I.R.A.", r); falar(r);
            } catch(e) { addLog("ERRO", "Falha ao consultar clima."); }
            return;
        }

        await pensarComGemini(val);
    }

    function iniciarMIRA() {
        document.getElementById('overlay').style.display = 'none';
        addLog("SISTEMA", "M.I.R.A. v10.0 ONLINE.");
        falar("Sistema iniciado. Como posso ajudar, Patrick?");
    }

    document.getElementById('inputComando').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') processar(e.target.value);
    });
</script>
</body>
</html>
